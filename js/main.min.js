function linearRegression(t,e){for(var r={},n=e.length,a=0,o=0,i=0,s=0,u=0,l=0;l<e.length;l++)a+=t[l],o+=e[l],i+=t[l]*e[l],s+=t[l]*t[l],u+=e[l]*e[l];return r.slope=(n*i-a*o)/(n*s-a*a),r.intercept=(o-r.slope*a)/n,r.r2=Math.pow((n*i-a*o)/Math.sqrt((n*s-a*a)*(n*u-o*o)),2),r.fn=function(t){return this.slope*t+this.intercept},r}function formatTempLabel(t){return t.toFixed(1)+" °C"}var Color=function(t,e,r){this.r=t,this.g=e,this.b=r};Color.prototype.toRGBString=function(){return"rgb("+this.r+","+this.g+","+this.b+")"},Color.prototype.toRGBAString=function(t){return"rgba("+this.r+","+this.g+","+this.b+","+t+")"},Object.freeze(Color);var debug=!1,inTempSensorId="0000068a3594",outTempSensorId="0000066eff45",timeWindowParam="now -2 hour",endpoint="https://data.sparkfun.com/output/",publicKey="OG62ZDJ65VC3x9jmWbK0",defaultColor=new Color(27,166,190),spectrum=[{offset:0,color:new Color(53,203,229)},{offset:.5,color:new Color(64,203,156)},{offset:.7,color:new Color(124,202,87)},{offset:.8,color:new Color(212,243,85)},{offset:.9,color:new Color(254,152,4)},{offset:1,color:new Color(223,51,65)}],minColorTemp=30,maxColorTemp=39,optimalTemp=36.5,currentTemp,currentEstimate,currentInSlope=0,currentOutSlope=0,maxEstimate=420,sampleCountForAvg=1,minSampleCountForEstimates=3,timeWindowForInEstimates=18e5,timeWindowForOutEstimates=6e5,displayUpdateInterval=4e3,displayAlertInterval=2e3,chartAnimate=!0,seq=0,delays=80,durations=500;$(function(){debug=!!getUrlParameter("debug"),startDisplayUpdates(),setInterval(function(){chartAnimate=!1,fetchData()},3e4),hideWarning(!1),fetchData()});var initChart=function(){chart=new Chartist.Line(".ct-chart",data,options),chart.on("created",function(){seq=0}),chart.on("draw",function(t){if("line"===t.type)t.element.animate({opacity:{begin:seq*delays+1e3,dur:durations,from:0,to:1}}),seq++;else if("label"===t.type&&"x"===t.axis)t.element.animate({y:{begin:seq*delays,dur:durations,from:t.y+100,to:t.y,easing:"easeOutQuart"}}),seq++;else if("label"===t.type&&"y"===t.axis)t.element.animate({x:{begin:seq*delays,dur:durations,from:t.x-100,to:t.x,easing:"easeOutQuart"}}),seq++;else if(chartAnimate&&"grid"===t.type){var e={begin:seq*delays,dur:durations,from:t[t.axis.units.pos+"1"]-30,to:t[t.axis.units.pos+"1"],easing:"easeOutQuart"},r={begin:seq*delays,dur:durations,from:t[t.axis.units.pos+"2"]-100,to:t[t.axis.units.pos+"2"],easing:"easeOutQuart"},n={};n[t.axis.units.pos+"1"]=e,n[t.axis.units.pos+"2"]=r,n.opacity={begin:seq*delays,dur:durations,from:0,to:1,easing:"easeOutQuart"},t.element.animate(n),seq++}})},lerp=function(t,e,r){return(1-r)*t+r*e},interpolateColor=function(t,e,r){var n=parseInt(lerp(t.r,e.r,r)),a=parseInt(lerp(t.g,e.g,r)),o=parseInt(lerp(t.b,e.b,r));return new Color(n,a,o)},animateStyleProperty=function(t,e,r,n,a,o){var i=null,s=null,u=function(l){i||(i=l),s||(s=l);var m=l-s,p=l-i,f=Math.min(p/a,1);f<1&&window.requestAnimationFrame(u),m<40||(s=l,t.style.setProperty(e,o(r,n,f)))};window.requestAnimationFrame(u)},showAlertOverlay=!1,startAlertToggling=function(){if(!showAlertOverlay){showAlertOverlay=!0;var t=document.getElementById("estimate-display"),e=t.children[0],r=0,n=setInterval(function(){r=1-r,showAlertOverlay||clearInterval(n),animateStyleProperty(e,"background-color",1-r,r,displayAlertInterval,function(t,e,r){return pickSpectrumHue(1).toRGBAString(Math.abs(r-t))})},displayAlertInterval)}},stopAlertToggling=function(){showAlertOverlay=!1},startDisplayUpdates=function(){var t=document.getElementById("temperature-value"),e=document.getElementById("estimate-value"),r=document.getElementById("estimate-label"),n=!1,a=!1;setInterval(function(){var o="--",i=!1,s=currentTemp&&currentTemp>=36,u=currentTemp&&currentTemp>=38,l=currentOutSlope&&currentOutSlope<=0;if(u)o="<span>Poppaa!<span>";else if(s)o="<span>Paljuun!<span>";else if(l&&a)o="<span>P&ouml;kky&auml;!<span>";else{if(currentEstimate){var m=(currentEstimate-Date.now())/1e3/60;o=n&&m>0&&m<maxEstimate?formatClockEstimateHtml(currentEstimate):formatTimeEstimateHtml(m)}i=!0,n=!n}u||!s&&l?startAlertToggling():stopAlertToggling(),a=!a,t.innerHTML=formatTemperatureHtml(currentTemp),e.innerHTML=o,r.style.opacity=i?1:0},displayUpdateInterval)},getStopColor=function(t,e){var r=(t-minColorTemp)/(maxColorTemp-minColorTemp)-.2*e;return pickSpectrumHue(r)},pickSpectrumHue=function(t){t=Math.max(Math.min(t,1),0);var e=spectrum.findLastOrDefault(function(e){return e.offset<=t},spectrum[0]),r=spectrum.findFirstOrDefault(function(e){return e.offset>=t},spectrum[spectrum.length-1]);if(r.offset===e.offset)return e.color;var n=(t-e.offset)/(r.offset-e.offset);return interpolateColor(e.color,r.color,n)},updateCurrentTemp=function(t){var e;if(t.length>=sampleCountForAvg){var r=t.slice(-sampleCountForAvg);e=r.reduce(function(t,e){return t+e.temp},0)/sampleCountForAvg,e&&(updateTemperatureDisplayGradient(currentTemp,e),updateEstimateDisplayGradient(currentTemp,e),updateChartLineGradient(t),currentTemp=e)}},updateCurrentEstimate=function(t,e){if(t.length>=minSampleCountForEstimates){var r=linearRegressionForSamples(t,timeWindowForInEstimates);currentEstimate=parseInt(r.fn(optimalTemp)),currentInSlope=r.slope,debug&&(console.log("estimate",currentEstimate),console.log("in slope",currentInSlope))}if(e.length>=minSampleCountForEstimates){var r=linearRegressionForSamples(e,timeWindowForOutEstimates);currentOutSlope=r.slope,debug&&console.log("out slope",currentOutSlope)}},linearRegressionForSamples=function(t,e){var r=t[t.length-1].time-e,n=t.filter(function(t){return t.time>=r}),a=n.map(function(t){return t.temp}),o=n.map(function(t){return t.time});return linearRegression(a,o)},formatTemperatureHtml=function(t){if(t){var e=Math.round(10*t)/10,r=parseInt(e),n=parseInt(e%1*10);return r+"<span>."+n+"</span><strong>&deg;</strong>"}return"--"},formatTimeEstimateHtml=function(t){if(t>60){var e=Math.round(Math.min(t,maxEstimate)/60*10)/10,r=parseInt(e),n=parseInt(e%1*10);return t>maxEstimate?">"+r+"<span>h</span>":r+"."+n+"<span>h</span>"}return t>0?parseInt(t)+"<span>min</span>":"--"},formatClockEstimateHtml=function(t){return t?'<span style="font-size: 80%">'+moment(t).format("HH:mm")+"</span>":"--"},updateTemperatureDisplayGradient=function(t,e){var r=document.getElementById("temperature-display");updateDisplayGradient(r,t,e,function(t,e,r){for(var n=[],a=0;a<3;a++){var o=interpolateColor(t[a],e[a],r);n.push(o.toRGBString())}return"linear-gradient(to left, "+n[0]+" 0%, "+n[1]+" 50%, "+n[2]+" 100%)"})},updateEstimateDisplayGradient=function(t,e){var r=document.getElementById("estimate-display");updateDisplayGradient(r,t,e,function(t,e,r){for(var n=[],a=0;a<3;a++){var o=interpolateColor(t[a],e[a],r);n.push(o.toRGBString())}return"linear-gradient(to left, "+n[0]+" 0%, "+n[1]+" 50%, "+n[2]+" 100%)"})},updateDisplayGradient=function(t,e,r,n){for(var a=[],o=[],i=0;i<3;i++)a.push(e?getStopColor(e,i):defaultColor),o.push(r?getStopColor(r,i):defaultColor);animateStyleProperty(t,"background",a,o,2e3,n)},updateChartLineGradient=function(t){for(var e=document.getElementById("line-gradient"),r=t.map(function(t){return t.temp}),n=r.min(),a=r.max(),o=e.getElementsByTagName("stop"),i=(a-n)/o.length,s=0;s<o.length;s++){var u=a-s*i;o[s].style.setProperty("stop-color",getStopColor(u,0).toRGBString())}},showWarning=function(t,e){$("#warning").slideDown(e?400:0),$("#warning > span").text(t)},hideWarning=function(t){$("#warning").slideUp(t?400:0)},options={showLine:!0,axisX:{offset:30,labelInterpolationFnc:function(t,e,r){return formatTimeLabel(t,e,r)}},axisY:{offset:60,labelInterpolationFnc:function(t,e,r){return formatTempLabel(t,e,r)}}},formatTimeLabel=function(t,e,r){var n=moment(t),a=null;if(e>0){var o=moment(r[e-1]),i=moment(r[0]),s=moment(r[r.length-1]);if(s.diff(i,"minutes")<50){var u=parseInt(r.length/2);return 1===e||e===u?n.format("HH:mm"):null}if(o.hours()<n.hours()?a=moment(n.hours()+"00","hmm").format("HH:mm"):o.minutes()<30&&n.minutes()>=30?a=moment(n.hours()+"30","hmm").format("HH:mm"):o.date()!=n.date()&&(a=n.format("ddd")),s.diff(n,"minutes")<20)return null}return a},data={},chart=null,fetchData=function(){$.ajax({url:"http://data.sparkfun.com/output/"+publicKey+".json",jsonp:"callback",cache:!0,dataType:"jsonp",data:{"gte[timestamp]":timeWindowParam},success:function(t){handleResponse(t)},error:function(t,e,r){debug&&console.error("Referesh failed: "+e),0==XMLHttpRequest.readyState&&showWarning("Yhteysongelma!",!0)}})},handleResponse=function(t){t instanceof Array&&t.length>=4?refreshValues(t):(debug&&console.log("Not enough data for calculations."),hideWarning(!0))},refreshValues=function(t){t=t.map(function(t){return convertSample(t)}),t.reverse(),isDataOutdated(t)?showWarning("Viimeisin lämpötilamittaus yli 5 minuuttia vanha."):hideWarning(!0);var e=t.filter(function(t){return t.id===inTempSensorId}),r=t.filter(function(t){return t.id===outTempSensorId});e=e.filter(function(t,e){return e%2===0}),r=r.filter(function(t,e){return e%2===0}),updateCurrentTemp(e),updateCurrentEstimate(e,r),data.labels=e.map(function(t){return t.time}),data.series=[],data.series.push(e.map(function(t){return t.temp})),debug&&data.series.push(r.map(function(t){return t.temp})),chart?(chart.data=data,chart.update()):initChart()},isDataOutdated=function(t){var e=moment(),r=moment(t[t.length-1].time);return e.diff(r,"minutes")>5},convertSample=function(t){return{id:trimSensorId(t.id),time:new Date(t.timestamp).getTime(),temp:parseFloat(t.temp)}},trimSensorId=function(t){return t.substring(1,t.length-1)},toLocalDate=function(t){var e=new Date(t),r=new Date;return r.setTime(e.getTime()+6e4*r.getTimezoneOffset()),r},getUrlParameter=function(t){var e,r,n=decodeURIComponent(window.location.search.substring(1)),a=n.split("&");for(r=0;r<a.length;r++)if(e=a[r].split("="),e[0]===t)return void 0===e[1]||e[1]};Array.prototype.max=function(){return Math.max.apply(null,this)},Array.prototype.min=function(){return Math.min.apply(null,this)},Array.prototype.findFirstOrDefault=function(t,e){for(var r=0;r<this.length;r++)if(r in this&&t(this[r]))return this[r];return e},Array.prototype.findLastOrDefault=function(t,e){for(var r=this.length-1;r>=0;r--)if(r in this&&t(this[r]))return this[r];return e};var isNumeric=function(t){return!isNaN(parseFloat(t))&&isFinite(t)},generateData=function(t,e,r,n,a){var o=n/a,s=(r-e)/o,u=Date.now()-n,l=[];for(i=0;i<o;i++)l.push({temp:e+i*s,id:t,time:u+i*a});return l};